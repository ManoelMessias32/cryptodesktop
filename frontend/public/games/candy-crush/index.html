<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    <title>Candy Crush - CryptoBot</title>

    <!-- Essencial pro Telegram Mini App -->
    <meta property="og:image" content="https://cryptodesktop.vercel.app/games/candy-crush/utils/red-candy.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preconnect" href="https://cryptodesktop.vercel.app">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html, body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
            touch-action: manipulation;
        }
        body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .score-board {
            background: rgba(0,0,0,0.6);
            padding: 12px 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #fff;
        }
        .grid-container {
            width: 100%;
            max-width: 420px;
            aspect-ratio: 1 / 1;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 6px;
            gap: 2px;
            touch-action: manipulation;
        }
        .grid div {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 6px;
            transition: transform 0.15s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .grid div.selected {
            border: 3px solid #ffeb3b !important;
            transform: scale(1.12);
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="score-board">
    <h3>Score</h3>
    <h1 id="score">0</h1>
</div>
<div class="grid-container">
    <div class="grid"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.querySelector('.grid');
        const scoreDisplay = document.getElementById('score');
        const width = 8;
        const squares = [];
        let score = 0;

        const candyColors = [
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/red-candy.png)',
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/blue-candy.png)',
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/green-candy.png)',
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/yellow-candy.png)',
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/orange-candy.png)',
            'url(https://cryptodesktop.vercel.app/games/candy-crush/utils/purple-candy.png)'
        ];

        function createBoard() {
            for (let i = 0; i < width * width; i++) {
                const square = document.createElement('div');
                square.setAttribute('id', i);
                let randomColor = Math.floor(Math.random() * candyColors.length);
                square.style.backgroundImage = candyColors[randomColor];
                grid.appendChild(square);
                squares.push(square);
            }
        }

        createBoard();

        // FIX DEFINITIVO DO TOUCH — AQUI É O LUGAR CERTO (depois do createBoard)
        squares.forEach(square => {
            // Clique com mouse (PC)
            square.addEventListener('click', squareClick);

            // Toque com dedo — FUNCIONA 100% NO TELEGRAM
            square.addEventListener('touchstart', function(e) {
                e.preventDefault();
                squareClick.call(this);
            }, { passive: false });
        });

        runGameLoop();

        let firstSquare = null;

        function squareClick() {
            if (firstSquare === null) {
                firstSquare = this;
                this.classList.add('selected');
            } else {
                const secondSquare = this;
                firstSquare.classList.remove('selected');
                if (firstSquare === secondSquare) { firstSquare = null; return; }

                const firstId = parseInt(firstSquare.id);
                const secondId = parseInt(secondSquare.id);
                const validMoves = [firstId - 1, firstId + 1, firstId - width, firstId + width];
                if (validMoves.includes(secondId)) {
                    swapSquares(firstSquare, secondSquare);
                    setTimeout(() => {
                        if (!runGameLoop()) {
                            swapSquares(firstSquare, secondSquare);
                        }
                    }, 200);
                }
                firstSquare = null;
            }
        }

        function swapSquares(a, b) {
            const temp = a.style.backgroundImage;
            a.style.backgroundImage = b.style.backgroundImage;
            b.style.backgroundImage = temp;
        }

        function runGameLoop() {
            const matches = checkAllMatches();
            if (matches.length > 0) {
                removeMatches(matches);
                setTimeout(() => {
                    moveDownAndRefill();
                    setTimeout(runGameLoop, 300);
                }, 200);
                return true;
            }
            return false;
        }

        function checkAllMatches() {
            const matches = new Set();
            for (let i = 0; i < width * width; i++) {
                const color = squares[i].style.backgroundImage;
                if (!color) continue;

                if (i % width < width - 2 && squares[i+1].style.backgroundImage === color && squares[i+2].style.backgroundImage === color) {
                    matches.add(i); matches.add(i+1); matches.add(i+2);
                }
                if (i < width * (width - 2) && squares[i + width].style.backgroundImage === color && squares[i + 2*width].style.backgroundImage === color) {
                    matches.add(i); matches.add(i + width); matches.add(i + 2*width);
                }
            }
            return Array.from(matches);
        }

        function removeMatches(matches) {
            score += matches.length * 10;
            scoreDisplay.textContent = score;
            matches.forEach(i => squares[i].style.backgroundImage = '');
        }

        function moveDownAndRefill() {
            for (let c = 0; c < width; c++) {
                let write = (width - 1) * width + c;
                for (let r = width - 1; r >= 0; r--) {
                    const read = r * width + c;
                    if (squares[read].style.backgroundImage) {
                        if (read !== write) {
                            squares[write].style.backgroundImage = squares[read].style.backgroundImage;
                            squares[read].style.backgroundImage = '';
                        }
                        write -= width;
                    }
                }
                for (let r = Math.floor(write / width); r >= 0; r--) {
                    const idx = r * width + c;
                    squares[idx].style.backgroundImage = candyColors[Math.floor(Math.random() * candyColors.length)];
                }
            }
        }
    });
</script>
</body>
</html>